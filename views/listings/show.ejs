<% layout("/layouts/boilerplate") %>

    <style>
        .show-listing-header {
            background: linear-gradient(135deg, #fe424d 0%, #e63946 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .show-listing-header h3 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .show-listing-container {
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .show-page-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .show-page-actions .btn {
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .show-page-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Tax Toggle Section */
        .tax-toggle-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }

        .tax-toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
            color: #333;
        }

        .tax-toggle-input {
            display: none;
        }

        .tax-toggle-slider {
            position: relative;
            width: 50px;
            height: 25px;
            background: #ccc;
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .tax-toggle-slider:before {
            content: '';
            position: absolute;
            width: 21px;
            height: 21px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .tax-toggle-input:checked+.tax-toggle-slider {
            background: #fe424d;
        }

        .tax-toggle-input:checked+.tax-toggle-slider:before {
            transform: translateX(25px);
        }

        .tax-toggle-text {
            font-size: 0.95rem;
            font-weight: 600;
        }
    </style>

    <div class="row mt-3">
        <div class="col-12">
            <div class="show-listing-header">
                <h3><i class="fa-solid fa-map-marker-alt"></i>
                    <%= currListing.title %>
                </h3>
            </div>
        </div>

        <!-- Tax Toggle Section -->
        <div class="col-8 offset-2">
            <div class="tax-toggle-section">
                <label class="tax-toggle-label">
                    <input type="checkbox" id="taxToggle" class="tax-toggle-input">
                    <span class="tax-toggle-slider"></span>
                    <span class="tax-toggle-text">Display total before taxes</span>
                </label>
            </div>
        </div>

        <div class="col-8 offset-2">
            <div class="show-listing-container">
                <div class="card show-card">
                    <img src="<%= currListing.image.url %>" class="card-img-top show-img" alt="listing_image" />
                    <div class="card-body">
                        <p class="card-text">
                            <%= currListing.description %>
                        </p>
                        <hr />
                        <p class="card-text">
                            <span class="price-display">
                                &#8377; <span class="base-price" data-price="<%= currListing.price || 0 %>">
                                    <%= currListing.price.toLocaleString("en-IN") %>
                                </span>
                                <span class="tax-price" style="display: none;">
                                    &#8377; <%= Math.round(currListing.price * 1.18).toLocaleString("en-IN") %>
                                        <small class="tax-label">(18% GST)</small>
                                </span>
                            </span>
                        </p>
                        <p class="card-text">
                            <%= currListing.location %>
                        </p>
                        <p class="card-text">
                            <%= currListing.country %>
                        </p>
                        <p class="card-text">
                            <% if (currListing.owner) { %>
                                <%= currListing.owner.username %>
                                    <% } else { %>
                                        <em>No owner</em>
                                        <% } %>
                        </p>
                        <hr />

                        <% if(currUser && currUser._id.equals(currListing.owner._id)) { %>
                            <div class="show-page-actions">
                                <a href="/listings/<%= currListing._id %>/edit" class="btn btn-dark">Edit</a>
                                <form method="POST" action="/listings/<%= currListing._id %>?_method=DELETE">
                                    <button class="btn btn-danger">Delete</button>
                                </form>
                            </div>
                            <% } %>

                                <% if(currUser) { %>
                                    <div class="reviews">
                                        <hr>
                                        <h4>Write a Review!</h4>
                                        <form action="/listings/<%= currListing._id %>/reviews" method="POST"
                                            class="needs-validation" novalidate>
                                            <!-- Star rating -->
                                            <fieldset class="starability-heartbeat">
                                                <legend>Star rating:</legend>
                                                <input type="radio" id="no-rate" class="input-no-rate"
                                                    name="review[rating]" value="0" checked aria-label="No rating." />
                                                <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                                                <label for="first-rate1" title="Terrible">1 star</label>
                                                <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                                                <label for="first-rate2" title="Not good">2 stars</label>
                                                <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                                                <label for="first-rate3" title="Average">3 stars</label>
                                                <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                                                <label for="first-rate4" title="Very good">4 stars</label>
                                                <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                                                <label for="first-rate5" title="Amazing">5 stars</label>
                                            </fieldset>

                                            <!-- Comment box -->
                                            <div class="mb-3">
                                                <label for="comment" class="form-label">Comments</label>
                                                <textarea name="review[comment]" id="comment" rows="4"
                                                    class="form-control" required></textarea>
                                                <div class="invalid-feedback">Please add some comments for your review.
                                                </div>
                                            </div>

                                            <button type="submit" class="btn btn-outline-dark">Submit</button>
                                        </form>
                                    </div>
                                    <% } %>

                                        <hr>
                                        <h4>All Reviews</h4>
                                        <div class="row">
                                            <% for(let review of currListing.reviews) { %>
                                                <div class="col-lg-6 mb-3">
                                                    <div class="card review-card">
                                                        <div class="card-body">
                                                            <h4>@<%= review.author.username %>
                                                            </h4>
                                                            <p class="card-text">
                                                                <%= review.comment %>
                                                            </p>

                                                            <p class="starability-result"
                                                                data-rating="<%= review.rating %>">
                                                                Rated: <%= review.rating %> stars
                                                            </p>
                                                            <form class="mt-2"
                                                                action="/listings/<%= currListing._id %>/reviews/<%= review._id %>?_method=DELETE"
                                                                method="POST">
                                                                <button class="btn btn-sm btn-dark">Delete</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                                <% } %>
                                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Tax Toggle on Show Page -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const taxToggle = document.getElementById('taxToggle');
            if (taxToggle) {
                const basePrice = document.querySelector('.base-price');
                const taxPrice = document.querySelector('.tax-price');

                // Load saved tax preference
                const taxEnabled = localStorage.getItem('taxEnabled') === 'true';
                if (taxEnabled) {
                    taxToggle.checked = true;
                    toggleTaxDisplay(true);
                }

                taxToggle.addEventListener('change', function () {
                    const isEnabled = this.checked;
                    localStorage.setItem('taxEnabled', isEnabled);
                    toggleTaxDisplay(isEnabled);
                });

                function toggleTaxDisplay(showTax) {
                    if (basePrice && taxPrice) {
                        basePrice.style.display = showTax ? 'none' : 'inline';
                        taxPrice.style.display = showTax ? 'inline' : 'none';
                    }
                }
            }
        });
    </script>